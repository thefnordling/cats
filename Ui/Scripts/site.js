"use strict";
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (Object.hasOwnProperty.call(mod, k)) result[k] = mod[k];
    result["default"] = mod;
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
require("bootstrap");
require("../scss/_bootstrap-custom.scss");
var ag_grid_community_1 = require("ag-grid-community");
require("ag-grid-community/dist/styles/ag-grid.css");
require("ag-grid-community/dist/styles/ag-theme-balham.css");
var signalR = __importStar(require("@aspnet/signalr"));
var client_1 = require("./nswag/client");
var moment = require("moment");
var Site = /** @class */ (function () {
    function Site() {
        var _this = this;
        this.siteRoot = window.__site_root;
        this.gridOptions = {};
        this.hubConnection = new signalR.HubConnectionBuilder()
            .withUrl(this.siteRoot + "/hub")
            .build();
        this.catsClient = new client_1.CatsClient(this.siteRoot);
        this.$catModal = $('#cat-modal');
        this.$catTitle = $('#cat-modal-title');
        this.$confirmSave = $('#confirm-save');
        this.$deleteModal = $('#delete-modal');
        this.$deleteCatName = $('#delete-modal-cat-name');
        this.$confirmDelete = $('#confirm-delete');
        this.$catId = $('#cat-id');
        this.$catName = $('#cat-name');
        this.$catBirth = $('#cat-birth');
        this.$catMood = $('#cat-mood');
        this.$catHungry = $('#cat-hungry');
        this.gridOptions.columnDefs = this.getColumns();
        this.gridOptions.getRowNodeId = function (cat) { return cat.id || ""; };
        this.gridOptions.rowSelection = 'single';
        this.gridOptions.defaultColDef = {
            sortable: true,
            resizable: true
        };
        this.gridOptions.enableCellChangeFlash = true;
        this.gridOptions.rowData = [];
        this.gridOptions.onSelectionChanged = function (event) { return _this.gridSelectionChanged(event); };
        var eGridDiv = document.querySelector('#cat-grid');
        new ag_grid_community_1.Grid(eGridDiv, this.gridOptions);
        this.catsClient.get(function (cats) { return _this.loadCats(cats); });
        $('.modal-action').click(function (e) {
            var $target = $(e.target);
            if ($target.data('action') && $target.data('target')) {
                $($target.data('target')).data('action', $target.data('action'));
            }
        });
        this.$catModal.on('show.bs.modal', function () { return _this.catModalShown(); });
        this.$deleteModal.on('show.bs.modal', function () { return _this.deleteModalShown(); });
        this.catFlatpicker = window.flatpickr(document.querySelector('#cat-birth'), {
            enableTime: true
        });
        this.$confirmSave.click(function () { return _this.saveCat(); });
        this.$confirmDelete.click(function () { return _this.deleteCat(); });
        this.hubConnection.start().catch(function (err) { return console.log(err); });
        this.hubConnection.on("updateCat", function (c) { return _this.updateCat(c); });
        this.hubConnection.on("deleteCat", function (c) { return _this.removeCat(c); });
    }
    Site.prototype.updateCat = function (c) {
        if (!c || !c.id) {
            return;
        }
        if (this.gridOptions.api.getRowNode(c.id)) {
            this.gridOptions.api.updateRowData({ update: [c] });
        }
        else {
            this.gridOptions.api.updateRowData({ add: [c] });
        }
    };
    Site.prototype.removeCat = function (c) {
        if (!c || !c.id) {
            return;
        }
        this.gridOptions.api.updateRowData({ remove: [c] });
    };
    Site.prototype.saveCat = function () {
        var _this = this;
        var cat = this.getCatFromModal();
        this.catsClient.insertUpdate(cat, function (c) {
            if (c) {
                _this.hubConnection.invoke("catUpdated", c);
                _this.$catModal.modal('hide');
            }
        });
    };
    Site.prototype.deleteCat = function () {
        var _this = this;
        var cat = this.getSelectedCat();
        if (cat) {
            this.catsClient.delete(cat, function (c) {
                if (c) {
                    _this.hubConnection.invoke("catDeleted", c);
                    _this.$deleteModal.modal('hide');
                }
            });
        }
    };
    Site.prototype.gridSelectionChanged = function (event) {
        var selected = this.getSelectedCat();
        if (selected) {
            $('.selection-required').prop('disabled', false);
        }
        else {
            $('.selection-required').prop('disabled', true);
        }
    };
    Site.prototype.catModalShown = function () {
        if (this.$catModal.data('action') == 'add') {
            this.setModalFromCat();
            this.$catTitle.text("Add A Cat");
        }
        else {
            var selected = this.getSelectedCat() || new client_1.Cat();
            this.setModalFromCat(selected);
            this.$catTitle.text("Edit A Cat");
        }
    };
    Site.prototype.deleteModalShown = function () {
        var selected = this.getSelectedCat();
        if (selected && selected.name) {
            this.$deleteCatName.text(selected.name);
        }
        else if (selected) {
            this.$deleteCatName.text(selected.id || "Undefined");
        }
    };
    Site.prototype.loadCats = function (cats) {
        this.gridOptions.api.setRowData(cats || []);
    };
    Site.prototype.getColumns = function () {
        var _this = this;
        return [
            { headerName: "Id", field: "id", hide: true },
            { headerName: "Name", field: "name" },
            { headerName: "Birth", field: "birth", valueFormatter: function (params) { return _this.formatBirth(params); } },
            { headerName: "Hungry", field: "hungry", cellRenderer: function (p) { return _this.renderHungry(p); } },
            { headerName: "Mood", field: "mood", cellRenderer: function (p) { return _this.renderMood(p); } }
        ];
    };
    Site.prototype.formatBirth = function (p) {
        if (!p.value) {
            return "";
        }
        return moment(p.value).format("YYYY-MM-DD hh:mm");
    };
    Site.prototype.renderHungry = function (p) {
        if (p.data && p.data.hungry) {
            return '<i class="far fa-check-square"></i>';
        }
        else {
            return '<i class="far fa-square"></i>';
        }
    };
    Site.prototype.renderMood = function (p) {
        if (!p.data || !p.data.mood) {
            return '<i class="far"></i>';
        }
        else {
            switch (p.data.mood) {
                case 1:
                    return '<i class="fas fa-square" style="color: red"></i> Red';
                case 2:
                    return '<i class="fas fa-square" style="color: #FFBF00"></i> Amber';
                case 3:
                    return '<i class="fas fa-square" style="color: green"></i> Green';
                default:
                    return '<i class="far"></i>';
            }
        }
    };
    Site.prototype.getSelectedCat = function () {
        var selected = this.gridOptions.api.getSelectedNodes();
        if (selected && selected.length) {
            return selected[0].data;
        }
        return undefined;
    };
    Site.prototype.getCatFromModal = function () {
        return new client_1.Cat({
            id: this.getInputString(this.$catId),
            name: this.getInputString(this.$catName),
            birth: this.getInputDate(this.$catBirth),
            hungry: this.getInputBoolean(this.$catHungry),
            mood: this.getInputMood(this.$catMood)
        });
    };
    Site.prototype.setModalFromCat = function (cat) {
        cat = cat || new client_1.Cat();
        this.$catId.val(cat.id || "");
        this.$catName.val(cat.name || "");
        this.catFlatpicker.setDate(cat.birth);
        this.$catHungry.prop('checked', cat.hungry);
        this.$catMood.val(cat.mood);
    };
    Site.prototype.getInputString = function ($input) {
        var val = $input.val();
        if (val !== 0 && !val) {
            return undefined;
        }
        return String(val);
    };
    Site.prototype.getInputDate = function ($input) {
        var m = moment($input.val());
        if (!m.isValid()) {
            return moment().toDate();
        }
        else {
            return m.toDate();
        }
    };
    Site.prototype.getInputBoolean = function ($input) {
        return $input.is(':checked') || false;
    };
    Site.prototype.getInputMood = function ($input) {
        var val = $input.val();
        if (val == client_1.Mood.Amber) {
            return client_1.Mood.Amber;
        }
        else if (val == client_1.Mood.Green) {
            return client_1.Mood.Green;
        }
        else if (val == client_1.Mood.Red) {
            return client_1.Mood.Red;
        }
        else {
            return client_1.Mood.None;
        }
    };
    return Site;
}());
new Site();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2l0ZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbInNpdGUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7O0FBQUEscUJBQW1CO0FBQ25CLDBDQUF3QztBQUN4Qyx1REFBc047QUFDdE4scURBQW1EO0FBQ25ELDZEQUEyRDtBQUMzRCx1REFBMkM7QUFDM0MseUNBQXVEO0FBQ3ZELCtCQUFrQztBQUVsQztJQXlCSTtRQUFBLGlCQW1DQztRQTNERCxhQUFRLEdBQWlCLE1BQU8sQ0FBQyxXQUFXLENBQUM7UUFFbkMsZ0JBQVcsR0FBZ0IsRUFBRSxDQUFDO1FBQzlCLGtCQUFhLEdBQTBCLElBQUksT0FBTyxDQUFDLG9CQUFvQixFQUFFO2FBQzlFLE9BQU8sQ0FBSSxJQUFJLENBQUMsUUFBUSxTQUFNLENBQUM7YUFDL0IsS0FBSyxFQUFFLENBQUM7UUFFYixlQUFVLEdBQUcsSUFBSSxtQkFBVSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUMzQyxjQUFTLEdBQUcsQ0FBQyxDQUFDLFlBQVksQ0FBQyxDQUFDO1FBQzVCLGNBQVMsR0FBRyxDQUFDLENBQUMsa0JBQWtCLENBQUMsQ0FBQztRQUNsQyxpQkFBWSxHQUFHLENBQUMsQ0FBQyxlQUFlLENBQUMsQ0FBQztRQUVsQyxpQkFBWSxHQUFHLENBQUMsQ0FBQyxlQUFlLENBQUMsQ0FBQztRQUNsQyxtQkFBYyxHQUFHLENBQUMsQ0FBQyx3QkFBd0IsQ0FBQyxDQUFDO1FBQzdDLG1CQUFjLEdBQUcsQ0FBQyxDQUFDLGlCQUFpQixDQUFDLENBQUM7UUFFdEMsV0FBTSxHQUFHLENBQUMsQ0FBQyxTQUFTLENBQUMsQ0FBQztRQUN0QixhQUFRLEdBQUcsQ0FBQyxDQUFDLFdBQVcsQ0FBQyxDQUFDO1FBQzFCLGNBQVMsR0FBRyxDQUFDLENBQUMsWUFBWSxDQUFDLENBQUM7UUFDNUIsYUFBUSxHQUFHLENBQUMsQ0FBQyxXQUFXLENBQUMsQ0FBQztRQUMxQixlQUFVLEdBQUcsQ0FBQyxDQUFD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QUQsQ0FBQyxBQTlORCxJQThOQztBQUVELElBQUksSUFBSSxFQUFFLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgJ2Jvb3RzdHJhcCc7XHJcbmltcG9ydCBcIi4uL3Njc3MvX2Jvb3RzdHJhcC1jdXN0b20uc2Nzc1wiO1xyXG5pbXBvcnQgeyBHcmlkLCBHcmlkT3B0aW9ucywgUm93Tm9kZSwgUm93VmFsdWVDaGFuZ2VkRXZlbnQsIFJvd0RhdGFVcGRhdGVkRXZlbnQsIENvbERlZiwgU2VsZWN0aW9uQ2hhbmdlZEV2ZW50LCBWYWx1ZUZvcm1hdHRlclBhcmFtcywgVmFsdWVHZXR0ZXJQYXJhbXMsIElDZWxsUmVuZGVyZXJQYXJhbXMsIElDZWxsUmVuZGVyZXIgfSBmcm9tIFwiYWctZ3JpZC1jb21tdW5pdHlcIjtcclxuaW1wb3J0IFwiYWctZ3JpZC1jb21tdW5pdHkvZGlzdC9zdHlsZXMvYWctZ3JpZC5jc3NcIjtcclxuaW1wb3J0IFwiYWctZ3JpZC1jb21tdW5pdHkvZGlzdC9zdHlsZXMvYWctdGhlbWUtYmFsaGFtLmNzc1wiO1xyXG5pbXBvcnQgKiBhcyBzaWduYWxSIGZyb20gXCJAYXNwbmV0L3NpZ25hbHJcIjtcclxuaW1wb3J0IHsgQ2F0c0NsaWVudCwgQ2F0LCBNb29kIH0gZnJvbSBcIi4vbnN3YWcvY2xpZW50XCI7XHJcbmltcG9ydCBtb21lbnQgPSByZXF1aXJlKCdtb21lbnQnKTtcclxuXHJcbmNsYXNzIFNpdGUge1xyXG4gICAgc2l0ZVJvb3Q6IHN0cmluZyA9ICg8YW55PndpbmRvdykuX19zaXRlX3Jvb3Q7XHJcblxyXG4gICAgcHJvdGVjdGVkIGdyaWRPcHRpb25zID0gPEdyaWRPcHRpb25zPnt9O1xyXG4gICAgcHJvdGVjdGVkIGh1YkNvbm5lY3Rpb246IHNpZ25hbFIuSHViQ29ubmVjdGlvbiA9IG5ldyBzaWduYWxSLkh1YkNvbm5lY3Rpb25CdWlsZGVyKClcclxuICAgICAgICAud2l0aFVybChgJHt0aGlzLnNpdGVSb290fS9odWJgKVxyXG4gICAgICAgIC5idWlsZCgpO1xyXG5cclxuICAgIGNhdHNDbGllbnQgPSBuZXcgQ2F0c0NsaWVudCh0aGlzLnNpdGVSb290KTtcclxuICAgICRjYXRNb2RhbCA9ICQoJyNjYXQtbW9kYWwnKTtcclxuICAgICRjYXRUaXRsZSA9ICQoJyNjYXQtbW9kYWwtdGl0bGUnKTtcclxuICAgICRjb25maXJtU2F2ZSA9ICQoJyNjb25maXJtLXNhdmUnKTtcclxuXHJcbiAgICAkZGVsZXRlTW9kYWwgPSAkKCcjZGVsZXRlLW1vZGFsJyk7XHJcbiAgICAkZGVsZXRlQ2F0TmFtZSA9ICQoJyNkZWxldGUtbW9kYWwtY2F0LW5hbWUnKTtcclxuICAgICRjb25maXJtRGVsZXRlID0gJCgnI2NvbmZpcm0tZGVsZXRlJyk7XHJcblxyXG4gICAgJGNhdElkID0gJCgnI2NhdC1pZCcpO1xyXG4gICAgJGNhdE5hbWUgPSAkKCcjY2F0LW5hbWUnKTtcclxuICAgICRjYXRCaXJ0aCA9ICQoJyNjYXQtYmlydGgnKTtcclxuICAgICRjYXRNb29kID0gJCgnI2NhdC1tb29kJyk7XHJcbiAgICAkY2F0SHVuZ3J5ID0gJCgnI2NhdC1odW5ncnknKTtcclxuXHJcbiAgICBjYXRGbGF0cGlja2VyOiBhbnk7XHJcblxyXG4gICAgY29uc3RydWN0b3IoKSB7XHJcbiAgICAgICAgdGhpcy5ncmlkT3B0aW9ucy5jb2x1bW5EZWZzID0gdGhpcy5nZXRDb2x1bW5zKCk7XHJcbiAgICAgICAgdGhpcy5ncmlkT3B0aW9ucy5nZXRSb3dOb2RlSWQgPSAoY2F0OiBDYXQpID0+IGNhdC5pZCB8fCBcIlwiO1xyXG4gICAgICAgIHRoaXMuZ3JpZE9wdGlvbnMucm93U2VsZWN0aW9uID0gJ3NpbmdsZSc7XHJcbiAgICAgICAgdGhpcy5ncmlkT3B0aW9ucy5kZWZhdWx0Q29sRGVmID0ge1xyXG4gICAgICAgICAgICBzb3J0YWJsZTogdHJ1ZSxcclxuICAgICAgICAgICAgcmVzaXphYmxlOiB0cnVlXHJcbiAgICAgICAgfTtcclxuICAgICAgICB0aGlzLmdyaWRPcHRpb25zLmVuYWJsZUNlbGxDaGFuZ2VGbGFzaCA9IHRydWU7XHJcbiAgICAgICAgdGhpcy5ncmlkT3B0aW9ucy5yb3dEYXRhID0gW107XHJcbiAgICAgICAgdGhpcy5ncmlkT3B0aW9ucy5vblNlbGVjdGlvbkNoYW5nZWQgPSAoZXZlbnQ6IFNlbGVjdGlvbkNoYW5nZWRFdmVudCkgPT4gdGhpcy5ncmlkU2VsZWN0aW9uQ2hhbmdlZChldmVudCk7XHJcbiAgICAgICAgY29uc3QgZUdyaWREaXY6IEhUTUxFbGVtZW50ID0gPEhUTUxFbGVtZW50PmRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJyNjYXQtZ3JpZCcpO1xyXG4gICAgICAgIG5ldyBHcmlkKGVHcmlkRGl2LCB0aGlzLmdyaWRPcHRpb25zKTtcclxuXHJcbiAgICAgICAgdGhpcy5jYXRzQ2xpZW50LmdldCgoY2F0czogQ2F0W10gfCBudWxsKSA9PiB0aGlzLmxvYWRDYXRzKGNhdHMpKVxyXG5cclxuICAgICAgICAkKCcubW9kYWwtYWN0aW9uJykuY2xpY2soKGU6IEpRdWVyeS5DbGlja0V2ZW50KSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0ICR0YXJnZXQgPSAkKGUudGFyZ2V0KTtcclxuICAgICAgICAgICAgaWYgKCR0YXJnZXQuZGF0YSgnYWN0aW9uJykgJiYgJHRhcmdldC5kYXRhKCd0YXJnZXQnKSkge1xyXG4gICAgICAgICAgICAgICAgJCgkdGFyZ2V0LmRhdGEoJ3RhcmdldCcpKS5kYXRhKCdhY3Rpb24nLCAkdGFyZ2V0LmRhdGEoJ2FjdGlvbicpKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICB0aGlzLiRjYXRNb2RhbC5vbignc2hvdy5icy5tb2RhbCcsICgpID0+IHRoaXMuY2F0TW9kYWxTaG93bigpKTtcclxuICAgICAgICB0aGlzLiRkZWxldGVNb2RhbC5vbignc2hvdy5icy5tb2RhbCcsICgpID0+IHRoaXMuZGVsZXRlTW9kYWxTaG93bigpKTtcclxuICAgICAgICB0aGlzLmNhdEZsYXRwaWNrZXIgPSAoPGFueT53aW5kb3cpLmZsYXRwaWNrcig8SFRNTEVsZW1lbnQ+ZG9jdW1lbnQucXVlcnlTZWxlY3RvcignI2NhdC1iaXJ0aCcpLCB7XHJcbiAgICAgICAgICAgIGVuYWJsZVRpbWU6IHRydWVcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgdGhpcy4kY29uZmlybVNhdmUuY2xpY2soKCkgPT4gdGhpcy5zYXZlQ2F0KCkpO1xyXG4gICAgICAgIHRoaXMuJGNvbmZpcm1EZWxldGUuY2xpY2soKCkgPT4gdGhpcy5kZWxldGVDYXQoKSk7XHJcblxyXG4gICAgICAgIHRoaXMuaHViQ29ubmVjdGlvbi5zdGFydCgpLmNhdGNoKGVyciA9PiBjb25zb2xlLmxvZyhlcnIpKTtcclxuICAgICAgICB0aGlzLmh1YkNvbm5lY3Rpb24ub24oXCJ1cGRhdGVDYXRcIiwgKGM6IENhdCkgPT4gdGhpcy51cGRhdGVDYXQoYykpO1xyXG4gICAgICAgIHRoaXMuaHViQ29ubmVjdGlvbi5vbihcImRlbGV0ZUNhdFwiLCAoYzogQ2F0KSA9PiB0aGlzLnJlbW92ZUNhdChjKSk7XHJcbiAgICB9XHJcbiAgICB1cGRhdGVDYXQoYzogQ2F0KSB7XHJcbiAgICAgICAgaWYgKCFjIHx8ICFjLmlkKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmICh0aGlzLmdyaWRPcHRpb25zLmFwaSEuZ2V0Um93Tm9kZShjLmlkKSkge1xyXG4gICAgICAgICAgICB0aGlzLmdyaWRPcHRpb25zLmFwaSEudXBkYXRlUm93RGF0YSh7IHVwZGF0ZTogW2NdIH0pO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHRoaXMuZ3JpZE9wdGlvbnMuYXBpIS51cGRhdGVSb3dEYXRhKHsgYWRkOiBbY10gfSk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG4gICAgcmVtb3ZlQ2F0KGM6IENhdCkge1xyXG4gICAgICAgIGlmICghYyB8fCAhYy5pZCkge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXMuZ3JpZE9wdGlvbnMuYXBpIS51cGRhdGVSb3dEYXRhKHsgcmVtb3ZlOiBbY10gfSk7XHJcbiAgICB9XHJcbiAgICBzYXZlQ2F0KCkge1xyXG4gICAgICAgIGNvbnN0IGNhdCA9IHRoaXMuZ2V0Q2F0RnJvbU1vZGFsKCk7XHJcbiAgICAgICAgdGhpcy5jYXRzQ2xpZW50Lmluc2VydFVwZGF0ZShjYXQsIChjOiBDYXQgfCBudWxsKSA9PiB7XHJcbiAgICAgICAgICAgIGlmIChjKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmh1YkNvbm5lY3Rpb24uaW52b2tlKFwiY2F0VXBkYXRlZFwiLCBjKTtcclxuXHJcbiAgICAgICAgICAgICAgICB0aGlzLiRjYXRNb2RhbC5tb2RhbCgnaGlkZScpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcbiAgICBkZWxldGVDYXQoKSB7XHJcbiAgICAgICAgY29uc3QgY2F0ID0gdGhpcy5nZXRTZWxlY3RlZENhdCgpO1xyXG4gICAgICAgIGlmIChjYXQpIHtcclxuICAgICAgICAgICAgdGhpcy5jYXRzQ2xpZW50LmRlbGV0ZShjYXQsIChjOiBDYXQgfCBudWxsKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBpZiAoYykge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuaHViQ29ubmVjdGlvbi5pbnZva2UoXCJjYXREZWxldGVkXCIsIGMpO1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuJGRlbGV0ZU1vZGFsLm1vZGFsKCdoaWRlJyk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuICAgIGdyaWRTZWxlY3Rpb25DaGFuZ2VkKGV2ZW50OiBTZWxlY3Rpb25DaGFuZ2VkRXZlbnQpIHtcclxuICAgICAgICBjb25zdCBzZWxlY3RlZCA9IHRoaXMuZ2V0U2VsZWN0ZWRDYXQoKTtcclxuICAgICAgICBpZiAoc2VsZWN0ZWQpIHtcclxuICAgICAgICAgICAgJCgnLnNlbGVjdGlvbi1yZXF1aXJlZCcpLnByb3AoJ2Rpc2FibGVkJywgZmFsc2UpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICQoJy5zZWxlY3Rpb24tcmVxdWlyZWQnKS5wcm9wKCdkaXNhYmxlZCcsIHRydWUpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuICAgIGNhdE1vZGFsU2hvd24oKSB7XHJcbiAgICAgICAgaWYgKHRoaXMuJGNhdE1vZGFsLmRhdGEoJ2FjdGlvbicpID09ICdhZGQnKSB7XHJcbiAgICAgICAgICAgIHRoaXMuc2V0TW9kYWxGcm9tQ2F0KCk7XHJcbiAgICAgICAgICAgIHRoaXMuJGNhdFRpdGxlLnRleHQoXCJBZGQgQSBDYXRcIik7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgbGV0IHNlbGVjdGVkID0gdGhpcy5nZXRTZWxlY3RlZENhdCgpIHx8IG5ldyBDYXQoKTtcclxuICAgICAgICAgICAgdGhpcy5zZXRNb2RhbEZyb21DYXQoc2VsZWN0ZWQpO1xyXG4gICAgICAgICAgICB0aGlzLiRjYXRUaXRsZS50ZXh0KFwiRWRpdCBBIENhdFwiKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICBkZWxldGVNb2RhbFNob3duKCkge1xyXG4gICAgICAgIGNvbnN0IHNlbGVjdGVkID0gdGhpcy5nZXRTZWxlY3RlZENhdCgpO1xyXG4gICAgICAgIGlmIChzZWxlY3RlZCAmJiBzZWxlY3RlZC5uYW1lKSB7XHJcbiAgICAgICAgICAgIHRoaXMuJGRlbGV0ZUNhdE5hbWUudGV4dChzZWxlY3RlZC5uYW1lKTtcclxuICAgICAgICB9IGVsc2UgaWYgKHNlbGVjdGVkKSB7XHJcbiAgICAgICAgICAgIHRoaXMuJGRlbGV0ZUNhdE5hbWUudGV4dChzZWxlY3RlZC5pZCB8fCBcIlVuZGVmaW5lZFwiKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICBsb2FkQ2F0cyhjYXRzOiBDYXRbXSB8IG51bGwpIHtcclxuICAgICAgICB0aGlzLmdyaWRPcHRpb25zLmFwaSEuc2V0Um93RGF0YShjYXRzIHx8IFtdKTtcclxuICAgIH1cclxuICAgIGdldENvbHVtbnMoKTogQ29sRGVmW10ge1xyXG4gICAgICAgIHJldHVybiBbXHJcbiAgICAgICAgICAgIHsgaGVhZGVyTmFtZTogXCJJZFwiLCBmaWVsZDogXCJpZFwiLCBoaWRlOiB0cnVlIH0sXHJcbiAgICAgICAgICAgIHsgaGVhZGVyTmFtZTogXCJOYW1lXCIsIGZpZWxkOiBcIm5hbWVcIiB9LFxyXG4gICAgICAgICAgICB7IGhlYWRlck5hbWU6IFwiQmlydGhcIiwgZmllbGQ6IFwiYmlydGhcIiwgdmFsdWVGb3JtYXR0ZXI6IChwYXJhbXM6IFZhbHVlRm9ybWF0dGVyUGFyYW1zKSA9PiB0aGlzLmZvcm1hdEJpcnRoKHBhcmFtcykgfSxcclxuICAgICAgICAgICAgeyBoZWFkZXJOYW1lOiBcIkh1bmdyeVwiLCBmaWVsZDogXCJodW5ncnlcIiwgY2VsbFJlbmRlcmVyOiAocDogSUNlbGxSZW5kZXJlclBhcmFtcykgPT4gdGhpcy5yZW5kZXJIdW5ncnkocCkgfSxcclxuICAgICAgICAgICAgeyBoZWFkZXJOYW1lOiBcIk1vb2RcIiwgZmllbGQ6IFwibW9vZFwiLCBjZWxsUmVuZGVyZXI6IChwOiBJQ2VsbFJlbmRlcmVyUGFyYW1zKSA9PiB0aGlzLnJlbmRlck1vb2QocCkgfVxyXG4gICAgICAgIF1cclxuICAgIH1cclxuICAgIGZvcm1hdEJpcnRoKHA6IFZhbHVlRm9ybWF0dGVyUGFyYW1zKTogc3RyaW5nIHtcclxuICAgICAgICBpZiAoIXAudmFsdWUpIHtcclxuICAgICAgICAgICAgcmV0dXJuIFwiXCI7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXR1cm4gbW9tZW50KHAudmFsdWUpLmZvcm1hdChcIllZWVktTU0tREQgaGg6bW1cIik7XHJcbiAgICB9XHJcbiAgICByZW5kZXJIdW5ncnkocDogSUNlbGxSZW5kZXJlclBhcmFtcykge1xyXG4gICAgICAgIGlmIChwLmRhdGEgJiYgcC5kYXRhLmh1bmdyeSkge1xyXG4gICAgICAgICAgICByZXR1cm4gJzxpIGNsYXNzPVwiZmFyIGZhLWNoZWNrLXNxdWFyZVwiPjwvaT4nO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHJldHVybiAnPGkgY2xhc3M9XCJmYXIgZmEtc3F1YXJlXCI+PC9pPic7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG4gICAgcmVuZGVyTW9vZChwOiBJQ2VsbFJlbmRlcmVyUGFyYW1zKSB7XHJcbiAgICAgICAgaWYgKCFwLmRhdGEgfHwgIXAuZGF0YS5tb29kKSB7XHJcbiAgICAgICAgICAgIHJldHVybiAnPGkgY2xhc3M9XCJmYXJcIj48L2k+JztcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBzd2l0Y2ggKHAuZGF0YS5tb29kKSB7XHJcbiAgICAgICAgICAgICAgICBjYXNlIDE6XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICc8aSBjbGFzcz1cImZhcyBmYS1zcXVhcmVcIiBzdHlsZT1cImNvbG9yOiByZWRcIj48L2k+IFJlZCc7XHJcbiAgICAgICAgICAgICAgICBjYXNlIDI6XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICc8aSBjbGFzcz1cImZhcyBmYS1zcXVhcmVcIiBzdHlsZT1cImNvbG9yOiAjRkZCRjAwXCI+PC9pPiBBbWJlcic7XHJcbiAgICAgICAgICAgICAgICBjYXNlIDM6XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICc8aSBjbGFzcz1cImZhcyBmYS1zcXVhcmVcIiBzdHlsZT1cImNvbG9yOiBncmVlblwiPjwvaT4gR3JlZW4nO1xyXG4gICAgICAgICAgICAgICAgZGVmYXVsdDpcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gJzxpIGNsYXNzPVwiZmFyXCI+PC9pPic7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICBnZXRTZWxlY3RlZENhdCgpOiBDYXQgfCB1bmRlZmluZWQge1xyXG4gICAgICAgIGNvbnN0IHNlbGVjdGVkID0gdGhpcy5ncmlkT3B0aW9ucy5hcGkhLmdldFNlbGVjdGVkTm9kZXMoKTtcclxuICAgICAgICBpZiAoc2VsZWN0ZWQgJiYgc2VsZWN0ZWQubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBzZWxlY3RlZFswXS5kYXRhO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gdW5kZWZpbmVkO1xyXG4gICAgfVxyXG4gICAgZ2V0Q2F0RnJvbU1vZGFsKCk6IENhdCB7XHJcbiAgICAgICAgcmV0dXJuIG5ldyBDYXQoe1xyXG4gICAgICAgICAgICBpZDogdGhpcy5nZXRJbnB1dFN0cmluZyh0aGlzLiRjYXRJZCksXHJcbiAgICAgICAgICAgIG5hbWU6IHRoaXMuZ2V0SW5wdXRTdHJpbmcodGhpcy4kY2F0TmFtZSksXHJcbiAgICAgICAgICAgIGJpcnRoOiB0aGlzLmdldElucHV0RGF0ZSh0aGlzLiRjYXRCaXJ0aCksXHJcbiAgICAgICAgICAgIGh1bmdyeTogdGhpcy5nZXRJbnB1dEJvb2xlYW4odGhpcy4kY2F0SHVuZ3J5KSxcclxuICAgICAgICAgICAgbW9vZDogdGhpcy5nZXRJbnB1dE1vb2QodGhpcy4kY2F0TW9vZClcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuICAgIHNldE1vZGFsRnJvbUNhdChjYXQ/OiBDYXQpIHtcclxuICAgICAgICBjYXQgPSBjYXQgfHwgbmV3IENhdCgpO1xyXG5cclxuICAgICAgICB0aGlzLiRjYXRJZC52YWwoY2F0LmlkIHx8IFwiXCIpO1xyXG4gICAgICAgIHRoaXMuJGNhdE5hbWUudmFsKGNhdC5uYW1lIHx8IFwiXCIpO1xyXG4gICAgICAgIHRoaXMuY2F0RmxhdHBpY2tlci5zZXREYXRlKGNhdC5iaXJ0aCk7XHJcbiAgICAgICAgdGhpcy4kY2F0SHVuZ3J5LnByb3AoJ2NoZWNrZWQnLCBjYXQuaHVuZ3J5KTtcclxuICAgICAgICB0aGlzLiRjYXRNb29kLnZhbChjYXQubW9vZCk7XHJcbiAgICB9XHJcbiAgICBnZXRJbnB1dFN0cmluZygkaW5wdXQ6IEpRdWVyeTxIVE1MRWxlbWVudD4pOiBzdHJpbmcgfCB1bmRlZmluZWQge1xyXG4gICAgICAgIGNvbnN0IHZhbCA9ICRpbnB1dC52YWwoKTtcclxuICAgICAgICBpZiAodmFsICE9PSAwICYmICF2YWwpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIFN0cmluZyh2YWwpO1xyXG4gICAgfVxyXG4gICAgZ2V0SW5wdXREYXRlKCRpbnB1dDogSlF1ZXJ5PEhUTUxFbGVtZW50Pik6IERhdGUge1xyXG4gICAgICAgIGNvbnN0IG0gPSBtb21lbnQoJGlucHV0LnZhbCgpKTtcclxuICAgICAgICBpZiAoIW0uaXNWYWxpZCgpKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBtb21lbnQoKS50b0RhdGUoKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICByZXR1cm4gbS50b0RhdGUoKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICBnZXRJbnB1dEJvb2xlYW4oJGlucHV0OiBKUXVlcnk8SFRNTEVsZW1lbnQ+KTogYm9vbGVhbiB7XHJcbiAgICAgICAgcmV0dXJuICRpbnB1dC5pcygnOmNoZWNrZWQnKSB8fCBmYWxzZTtcclxuICAgIH1cclxuICAgIGdldElucHV0TW9vZCgkaW5wdXQ6IEpRdWVyeTxIVE1MRWxlbWVudD4pOiBNb29kIHtcclxuICAgICAgICBjb25zdCB2YWwgPSAkaW5wdXQudmFsKCk7XHJcbiAgICAgICAgaWYgKHZhbCA9PSBNb29kLkFtYmVyKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBNb29kLkFtYmVyO1xyXG4gICAgICAgIH0gZWxzZSBpZiAodmFsID09IE1vb2QuR3JlZW4pIHtcclxuICAgICAgICAgICAgcmV0dXJuIE1vb2QuR3JlZW47XHJcbiAgICAgICAgfSBlbHNlIGlmICh2YWwgPT0gTW9vZC5SZWQpIHtcclxuICAgICAgICAgICAgcmV0dXJuIE1vb2QuUmVkO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHJldHVybiBNb29kLk5vbmU7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG59XHJcblxyXG5uZXcgU2l0ZSgpOyJdfQ==