"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
require("bootstrap");
require("../scss/_bootstrap-custom.scss");
var ag_grid_community_1 = require("ag-grid-community");
require("ag-grid-community/dist/styles/ag-grid.css");
require("ag-grid-community/dist/styles/ag-theme-balham.css");
var signalR = require("@aspnet/signalr");
var client_1 = require("./nswag/client");
var moment = require("moment");
var Site = /** @class */ (function () {
    function Site() {
        var _this = this;
        this.siteRoot = window.__site_root;
        this.gridOptions = {};
        this.$catModal = $('#cat-modal');
        this.$catTitle = $('#cat-modal-title');
        this.$confirmSave = $('#confirm-save');
        this.$deleteModal = $('#delete-modal');
        this.$deleteCatName = $('#delete-modal-cat-name');
        this.$confirmDelete = $('#confirm-delete');
        this.$catId = $('#cat-id');
        this.$catName = $('#cat-name');
        this.$catBirth = $('#cat-birth');
        this.$catMood = $('#cat-mood');
        this.$catHungry = $('#cat-hungry');
        if (this.siteRoot.length > 1 && this.siteRoot.lastIndexOf("/") === this.siteRoot.length - 1) {
            this.siteRoot = this.siteRoot.substring(0, this.siteRoot.length - 1);
        }
        this.hubConnection = new signalR.HubConnectionBuilder()
            .withUrl(this.siteRoot + "/hub")
            .build();
        this.catsClient = new client_1.CatsClient(this.siteRoot);
        this.gridOptions.columnDefs = this.getColumns();
        this.gridOptions.getRowNodeId = function (cat) { return cat.id || ""; };
        this.gridOptions.rowSelection = 'single';
        this.gridOptions.defaultColDef = {
            sortable: true,
            resizable: true
        };
        this.gridOptions.enableCellChangeFlash = true;
        this.gridOptions.rowData = [];
        this.gridOptions.onSelectionChanged = function (event) { return _this.gridSelectionChanged(event); };
        var eGridDiv = document.querySelector('#cat-grid');
        new ag_grid_community_1.Grid(eGridDiv, this.gridOptions);
        this.catsClient.get(function (cats) { return _this.loadCats(cats); });
        $('.modal-action').click(function (e) {
            var $target = $(e.target);
            if ($target.data('action') && $target.data('target')) {
                $($target.data('target')).data('action', $target.data('action'));
            }
        });
        this.$catModal.on('show.bs.modal', function () { return _this.catModalShown(); });
        this.$deleteModal.on('show.bs.modal', function () { return _this.deleteModalShown(); });
        this.catFlatpicker = window.flatpickr(document.querySelector('#cat-birth'), {
            enableTime: true
        });
        this.$confirmSave.click(function () { return _this.saveCat(); });
        this.$confirmDelete.click(function () { return _this.deleteCat(); });
        this.hubConnection.start().catch(function (err) { return console.log(err); });
        this.hubConnection.on("updateCat", function (c) { return _this.updateCat(c); });
        this.hubConnection.on("deleteCat", function (c) { return _this.removeCat(c); });
    }
    Site.prototype.updateCat = function (c) {
        if (!c || !c.id) {
            return;
        }
        if (this.gridOptions.api.getRowNode(c.id)) {
            this.gridOptions.api.updateRowData({ update: [c] });
        }
        else {
            this.gridOptions.api.updateRowData({ add: [c] });
        }
    };
    Site.prototype.removeCat = function (c) {
        if (!c || !c.id) {
            return;
        }
        this.gridOptions.api.updateRowData({ remove: [c] });
    };
    Site.prototype.saveCat = function () {
        var _this = this;
        var cat = this.getCatFromModal();
        this.catsClient.insertUpdate(cat, function (c) {
            if (c) {
                _this.hubConnection.invoke("catUpdated", c);
                _this.$catModal.modal('hide');
            }
        });
    };
    Site.prototype.deleteCat = function () {
        var _this = this;
        var cat = this.getSelectedCat();
        if (cat) {
            this.catsClient.delete(cat, function (c) {
                if (c) {
                    _this.hubConnection.invoke("catDeleted", c);
                    _this.$deleteModal.modal('hide');
                }
            });
        }
    };
    Site.prototype.gridSelectionChanged = function (event) {
        var selected = this.getSelectedCat();
        if (selected) {
            $('.selection-required').prop('disabled', false);
        }
        else {
            $('.selection-required').prop('disabled', true);
        }
    };
    Site.prototype.catModalShown = function () {
        if (this.$catModal.data('action') == 'add') {
            this.setModalFromCat();
            this.$catTitle.text("Add A Cat");
        }
        else {
            var selected = this.getSelectedCat() || new client_1.Cat();
            this.setModalFromCat(selected);
            this.$catTitle.text("Edit A Cat");
        }
    };
    Site.prototype.deleteModalShown = function () {
        var selected = this.getSelectedCat();
        if (selected && selected.name) {
            this.$deleteCatName.text(selected.name);
        }
        else if (selected) {
            this.$deleteCatName.text(selected.id || "Undefined");
        }
    };
    Site.prototype.loadCats = function (cats) {
        this.gridOptions.api.setRowData(cats || []);
    };
    Site.prototype.getColumns = function () {
        var _this = this;
        return [
            { headerName: "Id", field: "id", hide: true },
            { headerName: "Name", field: "name" },
            { headerName: "Birth", field: "birth", valueFormatter: function (params) { return _this.formatBirth(params); } },
            { headerName: "Hungry", field: "hungry", cellRenderer: function (p) { return _this.renderHungry(p); } },
            { headerName: "Mood", field: "mood", cellRenderer: function (p) { return _this.renderMood(p); } }
        ];
    };
    Site.prototype.formatBirth = function (p) {
        if (!p.value) {
            return "";
        }
        return moment(p.value).format("YYYY-MM-DD hh:mm");
    };
    Site.prototype.renderHungry = function (p) {
        if (p.data && p.data.hungry) {
            return '<i class="far fa-check-square"></i>';
        }
        else {
            return '<i class="far fa-square"></i>';
        }
    };
    Site.prototype.renderMood = function (p) {
        if (!p.data || !p.data.mood) {
            return '<i class="far"></i>';
        }
        else {
            switch (p.data.mood) {
                case 1:
                    return '<i class="fas fa-square" style="color: red"></i> Red';
                case 2:
                    return '<i class="fas fa-square" style="color: #FFBF00"></i> Amber';
                case 3:
                    return '<i class="fas fa-square" style="color: green"></i> Green';
                default:
                    return '<i class="far"></i>';
            }
        }
    };
    Site.prototype.getSelectedCat = function () {
        var selected = this.gridOptions.api.getSelectedNodes();
        if (selected && selected.length) {
            return selected[0].data;
        }
        return undefined;
    };
    Site.prototype.getCatFromModal = function () {
        return new client_1.Cat({
            id: this.getInputString(this.$catId),
            name: this.getInputString(this.$catName),
            birth: this.getInputDate(this.$catBirth),
            hungry: this.getInputBoolean(this.$catHungry),
            mood: this.getInputMood(this.$catMood)
        });
    };
    Site.prototype.setModalFromCat = function (cat) {
        cat = cat || new client_1.Cat();
        this.$catId.val(cat.id || "");
        this.$catName.val(cat.name || "");
        this.catFlatpicker.setDate(cat.birth);
        this.$catHungry.prop('checked', cat.hungry);
        this.$catMood.val(cat.mood);
    };
    Site.prototype.getInputString = function ($input) {
        var val = $input.val();
        if (val !== 0 && !val) {
            return undefined;
        }
        return String(val);
    };
    Site.prototype.getInputDate = function ($input) {
        var m = moment($input.val());
        if (!m.isValid()) {
            return moment().toDate();
        }
        else {
            return m.toDate();
        }
    };
    Site.prototype.getInputBoolean = function ($input) {
        return $input.is(':checked') || false;
    };
    Site.prototype.getInputMood = function ($input) {
        var val = $input.val();
        if (val == client_1.Mood.Amber) {
            return client_1.Mood.Amber;
        }
        else if (val == client_1.Mood.Green) {
            return client_1.Mood.Green;
        }
        else if (val == client_1.Mood.Red) {
            return client_1.Mood.Red;
        }
        else {
            return client_1.Mood.None;
        }
    };
    return Site;
}());
new Site();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2l0ZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbInNpdGUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSxxQkFBbUI7QUFDbkIsMENBQXdDO0FBQ3hDLHVEQUFzTjtBQUN0TixxREFBbUQ7QUFDbkQsNkRBQTJEO0FBQzNELHlDQUEyQztBQUMzQyx5Q0FBdUQ7QUFDdkQsK0JBQWtDO0FBRWxDO0lBdUJJO1FBQUEsaUJBMkNDO1FBakVELGFBQVEsR0FBaUIsTUFBTyxDQUFDLFdBQVcsQ0FBQztRQUVuQyxnQkFBVyxHQUFnQixFQUFFLENBQUM7UUFJeEMsY0FBUyxHQUFHLENBQUMsQ0FBQyxZQUFZLENBQUMsQ0FBQztRQUM1QixjQUFTLEdBQUcsQ0FBQyxDQUFDLGtCQUFrQixDQUFDLENBQUM7UUFDbEMsaUJBQVksR0FBRyxDQUFDLENBQUMsZUFBZSxDQUFDLENBQUM7UUFFbEMsaUJBQVksR0FBRyxDQUFDLENBQUMsZUFBZSxDQUFDLENBQUM7UUFDbEMsbUJBQWMsR0FBRyxDQUFDLENBQUMsd0JBQXdCLENBQUMsQ0FBQztRQUM3QyxtQkFBYyxHQUFHLENBQUMsQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDO1FBRXRDLFdBQU0sR0FBRyxDQUFDLENBQUMsU0FBUyxDQUFDLENBQUM7UUFDdEIsYUFBUSxHQUFHLENBQUMsQ0FBQyxXQUFXLENBQUMsQ0FBQztRQUMxQixjQUFTLEdBQUcsQ0FBQyxDQUFDLFlBQVksQ0FBQyxDQUFDO1FBQzVCLGFBQVEsR0FBRyxDQUFDLENBQUMsV0FBVyxDQUFDLENBQUM7UUFDMUIsZUFBVSxHQUFHLENBQUMsQ0FBQyxhQUFhLENBQUMsQ0FBQztRQU0xQixJQUFJLElBQUksQ0FBQyxRQUFRLENBQUMsTUFBTSxHQUFHLENBQUMsSUFBSSxJQUFJLENBQUMsUUFBUSxDQUFDLFdBQVcsQ0FBQyxHQUFHLENBQUMsS0FBSyxJQUFJLENBQUMsUUFBUSxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUU7WUFDekYsSUFBSSxDQUFDLFFB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QUFLLEVBQUU7WUFDbkIsT0FBTyxhQUFJLENBQUMsS0FBSyxDQUFDO1NBQ3JCO2FBQU0sSUFBSSxHQUFHLElBQUksYUFBSSxDQUFDLEtBQUssRUFBRTtZQUMxQixPQUFPLGFBQUksQ0FBQyxLQUFLLENBQUM7U0FDckI7YUFBTSxJQUFJLEdBQUcsSUFBSSxhQUFJLENBQUMsR0FBRyxFQUFFO1lBQ3hCLE9BQU8sYUFBSSxDQUFDLEdBQUcsQ0FBQztTQUNuQjthQUFNO1lBQ0gsT0FBTyxhQUFJLENBQUMsSUFBSSxDQUFDO1NBQ3BCO0lBQ0wsQ0FBQztJQUNMLFdBQUM7QUFBRCxDQUFDLEFBcE9ELElBb09DO0FBRUQsSUFBSSxJQUFJLEVBQUUsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAnYm9vdHN0cmFwJztcclxuaW1wb3J0IFwiLi4vc2Nzcy9fYm9vdHN0cmFwLWN1c3RvbS5zY3NzXCI7XHJcbmltcG9ydCB7IEdyaWQsIEdyaWRPcHRpb25zLCBSb3dOb2RlLCBSb3dWYWx1ZUNoYW5nZWRFdmVudCwgUm93RGF0YVVwZGF0ZWRFdmVudCwgQ29sRGVmLCBTZWxlY3Rpb25DaGFuZ2VkRXZlbnQsIFZhbHVlRm9ybWF0dGVyUGFyYW1zLCBWYWx1ZUdldHRlclBhcmFtcywgSUNlbGxSZW5kZXJlclBhcmFtcywgSUNlbGxSZW5kZXJlciB9IGZyb20gXCJhZy1ncmlkLWNvbW11bml0eVwiO1xyXG5pbXBvcnQgXCJhZy1ncmlkLWNvbW11bml0eS9kaXN0L3N0eWxlcy9hZy1ncmlkLmNzc1wiO1xyXG5pbXBvcnQgXCJhZy1ncmlkLWNvbW11bml0eS9kaXN0L3N0eWxlcy9hZy10aGVtZS1iYWxoYW0uY3NzXCI7XHJcbmltcG9ydCAqIGFzIHNpZ25hbFIgZnJvbSBcIkBhc3BuZXQvc2lnbmFsclwiO1xyXG5pbXBvcnQgeyBDYXRzQ2xpZW50LCBDYXQsIE1vb2QgfSBmcm9tIFwiLi9uc3dhZy9jbGllbnRcIjtcclxuaW1wb3J0IG1vbWVudCA9IHJlcXVpcmUoJ21vbWVudCcpO1xyXG5cclxuY2xhc3MgU2l0ZSB7XHJcbiAgICBzaXRlUm9vdDogc3RyaW5nID0gKDxhbnk+d2luZG93KS5fX3NpdGVfcm9vdDtcclxuXHJcbiAgICBwcm90ZWN0ZWQgZ3JpZE9wdGlvbnMgPSA8R3JpZE9wdGlvbnM+e307XHJcbiAgICBwcm90ZWN0ZWQgaHViQ29ubmVjdGlvbjogc2lnbmFsUi5IdWJDb25uZWN0aW9uO1xyXG5cclxuICAgIGNhdHNDbGllbnQ6IENhdHNDbGllbnQ7XHJcbiAgICAkY2F0TW9kYWwgPSAkKCcjY2F0LW1vZGFsJyk7XHJcbiAgICAkY2F0VGl0bGUgPSAkKCcjY2F0LW1vZGFsLXRpdGxlJyk7XHJcbiAgICAkY29uZmlybVNhdmUgPSAkKCcjY29uZmlybS1zYXZlJyk7XHJcblxyXG4gICAgJGRlbGV0ZU1vZGFsID0gJCgnI2RlbGV0ZS1tb2RhbCcpO1xyXG4gICAgJGRlbGV0ZUNhdE5hbWUgPSAkKCcjZGVsZXRlLW1vZGFsLWNhdC1uYW1lJyk7XHJcbiAgICAkY29uZmlybURlbGV0ZSA9ICQoJyNjb25maXJtLWRlbGV0ZScpO1xyXG5cclxuICAgICRjYXRJZCA9ICQoJyNjYXQtaWQnKTtcclxuICAgICRjYXROYW1lID0gJCgnI2NhdC1uYW1lJyk7XHJcbiAgICAkY2F0QmlydGggPSAkKCcjY2F0LWJpcnRoJyk7XHJcbiAgICAkY2F0TW9vZCA9ICQoJyNjYXQtbW9vZCcpO1xyXG4gICAgJGNhdEh1bmdyeSA9ICQoJyNjYXQtaHVuZ3J5Jyk7XHJcblxyXG4gICAgY2F0RmxhdHBpY2tlcjogYW55O1xyXG5cclxuICAgIGNvbnN0cnVjdG9yKCkge1xyXG5cclxuICAgICAgICBpZiAodGhpcy5zaXRlUm9vdC5sZW5ndGggPiAxICYmIHRoaXMuc2l0ZVJvb3QubGFzdEluZGV4T2YoXCIvXCIpID09PSB0aGlzLnNpdGVSb290Lmxlbmd0aCAtIDEpIHtcclxuICAgICAgICAgICAgdGhpcy5zaXRlUm9vdCA9IHRoaXMuc2l0ZVJvb3Quc3Vic3RyaW5nKDAsIHRoaXMuc2l0ZVJvb3QubGVuZ3RoIC0gMSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXMuaHViQ29ubmVjdGlvbiA9IG5ldyBzaWduYWxSLkh1YkNvbm5lY3Rpb25CdWlsZGVyKClcclxuICAgICAgICAgICAgLndpdGhVcmwoYCR7dGhpcy5zaXRlUm9vdH0vaHViYClcclxuICAgICAgICAgICAgLmJ1aWxkKCk7XHJcbiAgICAgICAgdGhpcy5jYXRzQ2xpZW50ID0gbmV3IENhdHNDbGllbnQodGhpcy5zaXRlUm9vdCk7XHJcbiAgICAgICAgdGhpcy5ncmlkT3B0aW9ucy5jb2x1bW5EZWZzID0gdGhpcy5nZXRDb2x1bW5zKCk7XHJcbiAgICAgICAgdGhpcy5ncmlkT3B0aW9ucy5nZXRSb3dOb2RlSWQgPSAoY2F0OiBDYXQpID0+IGNhdC5pZCB8fCBcIlwiO1xyXG4gICAgICAgIHRoaXMuZ3JpZE9wdGlvbnMucm93U2VsZWN0aW9uID0gJ3NpbmdsZSc7XHJcbiAgICAgICAgdGhpcy5ncmlkT3B0aW9ucy5kZWZhdWx0Q29sRGVmID0ge1xyXG4gICAgICAgICAgICBzb3J0YWJsZTogdHJ1ZSxcclxuICAgICAgICAgICAgcmVzaXphYmxlOiB0cnVlXHJcbiAgICAgICAgfTtcclxuICAgICAgICB0aGlzLmdyaWRPcHRpb25zLmVuYWJsZUNlbGxDaGFuZ2VGbGFzaCA9IHRydWU7XHJcbiAgICAgICAgdGhpcy5ncmlkT3B0aW9ucy5yb3dEYXRhID0gW107XHJcbiAgICAgICAgdGhpcy5ncmlkT3B0aW9ucy5vblNlbGVjdGlvbkNoYW5nZWQgPSAoZXZlbnQ6IFNlbGVjdGlvbkNoYW5nZWRFdmVudCkgPT4gdGhpcy5ncmlkU2VsZWN0aW9uQ2hhbmdlZChldmVudCk7XHJcbiAgICAgICAgY29uc3QgZUdyaWREaXY6IEhUTUxFbGVtZW50ID0gPEhUTUxFbGVtZW50PmRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJyNjYXQtZ3JpZCcpO1xyXG4gICAgICAgIG5ldyBHcmlkKGVHcmlkRGl2LCB0aGlzLmdyaWRPcHRpb25zKTtcclxuXHJcbiAgICAgICAgdGhpcy5jYXRzQ2xpZW50LmdldCgoY2F0czogQ2F0W10gfCBudWxsKSA9PiB0aGlzLmxvYWRDYXRzKGNhdHMpKVxyXG5cclxuICAgICAgICAkKCcubW9kYWwtYWN0aW9uJykuY2xpY2soKGU6IEpRdWVyeS5DbGlja0V2ZW50KSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0ICR0YXJnZXQgPSAkKGUudGFyZ2V0KTtcclxuICAgICAgICAgICAgaWYgKCR0YXJnZXQuZGF0YSgnYWN0aW9uJykgJiYgJHRhcmdldC5kYXRhKCd0YXJnZXQnKSkge1xyXG4gICAgICAgICAgICAgICAgJCgkdGFyZ2V0LmRhdGEoJ3RhcmdldCcpKS5kYXRhKCdhY3Rpb24nLCAkdGFyZ2V0LmRhdGEoJ2FjdGlvbicpKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICB0aGlzLiRjYXRNb2RhbC5vbignc2hvdy5icy5tb2RhbCcsICgpID0+IHRoaXMuY2F0TW9kYWxTaG93bigpKTtcclxuICAgICAgICB0aGlzLiRkZWxldGVNb2RhbC5vbignc2hvdy5icy5tb2RhbCcsICgpID0+IHRoaXMuZGVsZXRlTW9kYWxTaG93bigpKTtcclxuICAgICAgICB0aGlzLmNhdEZsYXRwaWNrZXIgPSAoPGFueT53aW5kb3cpLmZsYXRwaWNrcig8SFRNTEVsZW1lbnQ+ZG9jdW1lbnQucXVlcnlTZWxlY3RvcignI2NhdC1iaXJ0aCcpLCB7XHJcbiAgICAgICAgICAgIGVuYWJsZVRpbWU6IHRydWVcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgdGhpcy4kY29uZmlybVNhdmUuY2xpY2soKCkgPT4gdGhpcy5zYXZlQ2F0KCkpO1xyXG4gICAgICAgIHRoaXMuJGNvbmZpcm1EZWxldGUuY2xpY2soKCkgPT4gdGhpcy5kZWxldGVDYXQoKSk7XHJcblxyXG4gICAgICAgIHRoaXMuaHViQ29ubmVjdGlvbi5zdGFydCgpLmNhdGNoKGVyciA9PiBjb25zb2xlLmxvZyhlcnIpKTtcclxuICAgICAgICB0aGlzLmh1YkNvbm5lY3Rpb24ub24oXCJ1cGRhdGVDYXRcIiwgKGM6IENhdCkgPT4gdGhpcy51cGRhdGVDYXQoYykpO1xyXG4gICAgICAgIHRoaXMuaHViQ29ubmVjdGlvbi5vbihcImRlbGV0ZUNhdFwiLCAoYzogQ2F0KSA9PiB0aGlzLnJlbW92ZUNhdChjKSk7XHJcbiAgICB9XHJcbiAgICB1cGRhdGVDYXQoYzogQ2F0KSB7XHJcbiAgICAgICAgaWYgKCFjIHx8ICFjLmlkKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmICh0aGlzLmdyaWRPcHRpb25zLmFwaSEuZ2V0Um93Tm9kZShjLmlkKSkge1xyXG4gICAgICAgICAgICB0aGlzLmdyaWRPcHRpb25zLmFwaSEudXBkYXRlUm93RGF0YSh7IHVwZGF0ZTogW2NdIH0pO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHRoaXMuZ3JpZE9wdGlvbnMuYXBpIS51cGRhdGVSb3dEYXRhKHsgYWRkOiBbY10gfSk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG4gICAgcmVtb3ZlQ2F0KGM6IENhdCkge1xyXG4gICAgICAgIGlmICghYyB8fCAhYy5pZCkge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXMuZ3JpZE9wdGlvbnMuYXBpIS51cGRhdGVSb3dEYXRhKHsgcmVtb3ZlOiBbY10gfSk7XHJcbiAgICB9XHJcbiAgICBzYXZlQ2F0KCkge1xyXG4gICAgICAgIGNvbnN0IGNhdCA9IHRoaXMuZ2V0Q2F0RnJvbU1vZGFsKCk7XHJcbiAgICAgICAgdGhpcy5jYXRzQ2xpZW50Lmluc2VydFVwZGF0ZShjYXQsIChjOiBDYXQgfCBudWxsKSA9PiB7XHJcbiAgICAgICAgICAgIGlmIChjKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmh1YkNvbm5lY3Rpb24uaW52b2tlKFwiY2F0VXBkYXRlZFwiLCBjKTtcclxuXHJcbiAgICAgICAgICAgICAgICB0aGlzLiRjYXRNb2RhbC5tb2RhbCgnaGlkZScpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcbiAgICBkZWxldGVDYXQoKSB7XHJcbiAgICAgICAgY29uc3QgY2F0ID0gdGhpcy5nZXRTZWxlY3RlZENhdCgpO1xyXG4gICAgICAgIGlmIChjYXQpIHtcclxuICAgICAgICAgICAgdGhpcy5jYXRzQ2xpZW50LmRlbGV0ZShjYXQsIChjOiBDYXQgfCBudWxsKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBpZiAoYykge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuaHViQ29ubmVjdGlvbi5pbnZva2UoXCJjYXREZWxldGVkXCIsIGMpO1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuJGRlbGV0ZU1vZGFsLm1vZGFsKCdoaWRlJyk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuICAgIGdyaWRTZWxlY3Rpb25DaGFuZ2VkKGV2ZW50OiBTZWxlY3Rpb25DaGFuZ2VkRXZlbnQpIHtcclxuICAgICAgICBjb25zdCBzZWxlY3RlZCA9IHRoaXMuZ2V0U2VsZWN0ZWRDYXQoKTtcclxuICAgICAgICBpZiAoc2VsZWN0ZWQpIHtcclxuICAgICAgICAgICAgJCgnLnNlbGVjdGlvbi1yZXF1aXJlZCcpLnByb3AoJ2Rpc2FibGVkJywgZmFsc2UpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICQoJy5zZWxlY3Rpb24tcmVxdWlyZWQnKS5wcm9wKCdkaXNhYmxlZCcsIHRydWUpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuICAgIGNhdE1vZGFsU2hvd24oKSB7XHJcbiAgICAgICAgaWYgKHRoaXMuJGNhdE1vZGFsLmRhdGEoJ2FjdGlvbicpID09ICdhZGQnKSB7XHJcbiAgICAgICAgICAgIHRoaXMuc2V0TW9kYWxGcm9tQ2F0KCk7XHJcbiAgICAgICAgICAgIHRoaXMuJGNhdFRpdGxlLnRleHQoXCJBZGQgQSBDYXRcIik7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgbGV0IHNlbGVjdGVkID0gdGhpcy5nZXRTZWxlY3RlZENhdCgpIHx8IG5ldyBDYXQoKTtcclxuICAgICAgICAgICAgdGhpcy5zZXRNb2RhbEZyb21DYXQoc2VsZWN0ZWQpO1xyXG4gICAgICAgICAgICB0aGlzLiRjYXRUaXRsZS50ZXh0KFwiRWRpdCBBIENhdFwiKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICBkZWxldGVNb2RhbFNob3duKCkge1xyXG4gICAgICAgIGNvbnN0IHNlbGVjdGVkID0gdGhpcy5nZXRTZWxlY3RlZENhdCgpO1xyXG4gICAgICAgIGlmIChzZWxlY3RlZCAmJiBzZWxlY3RlZC5uYW1lKSB7XHJcbiAgICAgICAgICAgIHRoaXMuJGRlbGV0ZUNhdE5hbWUudGV4dChzZWxlY3RlZC5uYW1lKTtcclxuICAgICAgICB9IGVsc2UgaWYgKHNlbGVjdGVkKSB7XHJcbiAgICAgICAgICAgIHRoaXMuJGRlbGV0ZUNhdE5hbWUudGV4dChzZWxlY3RlZC5pZCB8fCBcIlVuZGVmaW5lZFwiKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICBsb2FkQ2F0cyhjYXRzOiBDYXRbXSB8IG51bGwpIHtcclxuICAgICAgICB0aGlzLmdyaWRPcHRpb25zLmFwaSEuc2V0Um93RGF0YShjYXRzIHx8IFtdKTtcclxuICAgIH1cclxuICAgIGdldENvbHVtbnMoKTogQ29sRGVmW10ge1xyXG4gICAgICAgIHJldHVybiBbXHJcbiAgICAgICAgICAgIHsgaGVhZGVyTmFtZTogXCJJZFwiLCBmaWVsZDogXCJpZFwiLCBoaWRlOiB0cnVlIH0sXHJcbiAgICAgICAgICAgIHsgaGVhZGVyTmFtZTogXCJOYW1lXCIsIGZpZWxkOiBcIm5hbWVcIiB9LFxyXG4gICAgICAgICAgICB7IGhlYWRlck5hbWU6IFwiQmlydGhcIiwgZmllbGQ6IFwiYmlydGhcIiwgdmFsdWVGb3JtYXR0ZXI6IChwYXJhbXM6IFZhbHVlRm9ybWF0dGVyUGFyYW1zKSA9PiB0aGlzLmZvcm1hdEJpcnRoKHBhcmFtcykgfSxcclxuICAgICAgICAgICAgeyBoZWFkZXJOYW1lOiBcIkh1bmdyeVwiLCBmaWVsZDogXCJodW5ncnlcIiwgY2VsbFJlbmRlcmVyOiAocDogSUNlbGxSZW5kZXJlclBhcmFtcykgPT4gdGhpcy5yZW5kZXJIdW5ncnkocCkgfSxcclxuICAgICAgICAgICAgeyBoZWFkZXJOYW1lOiBcIk1vb2RcIiwgZmllbGQ6IFwibW9vZFwiLCBjZWxsUmVuZGVyZXI6IChwOiBJQ2VsbFJlbmRlcmVyUGFyYW1zKSA9PiB0aGlzLnJlbmRlck1vb2QocCkgfVxyXG4gICAgICAgIF1cclxuICAgIH1cclxuICAgIGZvcm1hdEJpcnRoKHA6IFZhbHVlRm9ybWF0dGVyUGFyYW1zKTogc3RyaW5nIHtcclxuICAgICAgICBpZiAoIXAudmFsdWUpIHtcclxuICAgICAgICAgICAgcmV0dXJuIFwiXCI7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXR1cm4gbW9tZW50KHAudmFsdWUpLmZvcm1hdChcIllZWVktTU0tREQgaGg6bW1cIik7XHJcbiAgICB9XHJcbiAgICByZW5kZXJIdW5ncnkocDogSUNlbGxSZW5kZXJlclBhcmFtcykge1xyXG4gICAgICAgIGlmIChwLmRhdGEgJiYgcC5kYXRhLmh1bmdyeSkge1xyXG4gICAgICAgICAgICByZXR1cm4gJzxpIGNsYXNzPVwiZmFyIGZhLWNoZWNrLXNxdWFyZVwiPjwvaT4nO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHJldHVybiAnPGkgY2xhc3M9XCJmYXIgZmEtc3F1YXJlXCI+PC9pPic7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG4gICAgcmVuZGVyTW9vZChwOiBJQ2VsbFJlbmRlcmVyUGFyYW1zKSB7XHJcbiAgICAgICAgaWYgKCFwLmRhdGEgfHwgIXAuZGF0YS5tb29kKSB7XHJcbiAgICAgICAgICAgIHJldHVybiAnPGkgY2xhc3M9XCJmYXJcIj48L2k+JztcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBzd2l0Y2ggKHAuZGF0YS5tb29kKSB7XHJcbiAgICAgICAgICAgICAgICBjYXNlIDE6XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICc8aSBjbGFzcz1cImZhcyBmYS1zcXVhcmVcIiBzdHlsZT1cImNvbG9yOiByZWRcIj48L2k+IFJlZCc7XHJcbiAgICAgICAgICAgICAgICBjYXNlIDI6XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICc8aSBjbGFzcz1cImZhcyBmYS1zcXVhcmVcIiBzdHlsZT1cImNvbG9yOiAjRkZCRjAwXCI+PC9pPiBBbWJlcic7XHJcbiAgICAgICAgICAgICAgICBjYXNlIDM6XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICc8aSBjbGFzcz1cImZhcyBmYS1zcXVhcmVcIiBzdHlsZT1cImNvbG9yOiBncmVlblwiPjwvaT4gR3JlZW4nO1xyXG4gICAgICAgICAgICAgICAgZGVmYXVsdDpcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gJzxpIGNsYXNzPVwiZmFyXCI+PC9pPic7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICBnZXRTZWxlY3RlZENhdCgpOiBDYXQgfCB1bmRlZmluZWQge1xyXG4gICAgICAgIGNvbnN0IHNlbGVjdGVkID0gdGhpcy5ncmlkT3B0aW9ucy5hcGkhLmdldFNlbGVjdGVkTm9kZXMoKTtcclxuICAgICAgICBpZiAoc2VsZWN0ZWQgJiYgc2VsZWN0ZWQubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBzZWxlY3RlZFswXS5kYXRhO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gdW5kZWZpbmVkO1xyXG4gICAgfVxyXG4gICAgZ2V0Q2F0RnJvbU1vZGFsKCk6IENhdCB7XHJcbiAgICAgICAgcmV0dXJuIG5ldyBDYXQoe1xyXG4gICAgICAgICAgICBpZDogdGhpcy5nZXRJbnB1dFN0cmluZyh0aGlzLiRjYXRJZCksXHJcbiAgICAgICAgICAgIG5hbWU6IHRoaXMuZ2V0SW5wdXRTdHJpbmcodGhpcy4kY2F0TmFtZSksXHJcbiAgICAgICAgICAgIGJpcnRoOiB0aGlzLmdldElucHV0RGF0ZSh0aGlzLiRjYXRCaXJ0aCksXHJcbiAgICAgICAgICAgIGh1bmdyeTogdGhpcy5nZXRJbnB1dEJvb2xlYW4odGhpcy4kY2F0SHVuZ3J5KSxcclxuICAgICAgICAgICAgbW9vZDogdGhpcy5nZXRJbnB1dE1vb2QodGhpcy4kY2F0TW9vZClcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuICAgIHNldE1vZGFsRnJvbUNhdChjYXQ/OiBDYXQpIHtcclxuICAgICAgICBjYXQgPSBjYXQgfHwgbmV3IENhdCgpO1xyXG5cclxuICAgICAgICB0aGlzLiRjYXRJZC52YWwoY2F0LmlkIHx8IFwiXCIpO1xyXG4gICAgICAgIHRoaXMuJGNhdE5hbWUudmFsKGNhdC5uYW1lIHx8IFwiXCIpO1xyXG4gICAgICAgIHRoaXMuY2F0RmxhdHBpY2tlci5zZXREYXRlKGNhdC5iaXJ0aCk7XHJcbiAgICAgICAgdGhpcy4kY2F0SHVuZ3J5LnByb3AoJ2NoZWNrZWQnLCBjYXQuaHVuZ3J5KTtcclxuICAgICAgICB0aGlzLiRjYXRNb29kLnZhbChjYXQubW9vZCk7XHJcbiAgICB9XHJcbiAgICBnZXRJbnB1dFN0cmluZygkaW5wdXQ6IEpRdWVyeTxIVE1MRWxlbWVudD4pOiBzdHJpbmcgfCB1bmRlZmluZWQge1xyXG4gICAgICAgIGNvbnN0IHZhbCA9ICRpbnB1dC52YWwoKTtcclxuICAgICAgICBpZiAodmFsICE9PSAwICYmICF2YWwpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIFN0cmluZyh2YWwpO1xyXG4gICAgfVxyXG4gICAgZ2V0SW5wdXREYXRlKCRpbnB1dDogSlF1ZXJ5PEhUTUxFbGVtZW50Pik6IERhdGUge1xyXG4gICAgICAgIGNvbnN0IG0gPSBtb21lbnQoJGlucHV0LnZhbCgpKTtcclxuICAgICAgICBpZiAoIW0uaXNWYWxpZCgpKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBtb21lbnQoKS50b0RhdGUoKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICByZXR1cm4gbS50b0RhdGUoKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICBnZXRJbnB1dEJvb2xlYW4oJGlucHV0OiBKUXVlcnk8SFRNTEVsZW1lbnQ+KTogYm9vbGVhbiB7XHJcbiAgICAgICAgcmV0dXJuICRpbnB1dC5pcygnOmNoZWNrZWQnKSB8fCBmYWxzZTtcclxuICAgIH1cclxuICAgIGdldElucHV0TW9vZCgkaW5wdXQ6IEpRdWVyeTxIVE1MRWxlbWVudD4pOiBNb29kIHtcclxuICAgICAgICBjb25zdCB2YWwgPSAkaW5wdXQudmFsKCk7XHJcbiAgICAgICAgaWYgKHZhbCA9PSBNb29kLkFtYmVyKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBNb29kLkFtYmVyO1xyXG4gICAgICAgIH0gZWxzZSBpZiAodmFsID09IE1vb2QuR3JlZW4pIHtcclxuICAgICAgICAgICAgcmV0dXJuIE1vb2QuR3JlZW47XHJcbiAgICAgICAgfSBlbHNlIGlmICh2YWwgPT0gTW9vZC5SZWQpIHtcclxuICAgICAgICAgICAgcmV0dXJuIE1vb2QuUmVkO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHJldHVybiBNb29kLk5vbmU7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG59XHJcblxyXG5uZXcgU2l0ZSgpOyJdfQ==